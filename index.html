<!DOCTYPE html>
<html>
<head>
<!--Import Google Icon Font-->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
<!-- Compiled and minified CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
<!-- Compiled and minified JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<!--Let browser know website is optimized for mobile-->
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.36/dist/web3.min.js" integrity="sha256-nWBTbvxhJgjslRyuAKJHK+XcZPlCnmIAAMixz6EefVk=" crossorigin="anonymous"></script>
<script language="javascript" type="text/javascript" src="abi.js"></script>
<script>
  window.addEventListener('load', async () => {
    const contractAdd = "0xe05d522cdBA3DD9aEba6cB41a4F2712E8c4F1C27";
    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
    const owner = accounts[0];
    const bidder1 = accounts[1];
    const bidder2 = accounts[3];

    if (window.ethereum) {
        window.web3 = new Web3(window.ethereum);
        window.ethereum.enable();
    }
    var AuctionContract = new window.web3.eth.Contract(abi, contractAdd);

    const bidder1Funds = async () => {
      let funds = await AuctionContract.methods.getBidderFunds().call({from: bidder1});
      return funds;
    }
    const bidder2Funds = async () => {
      let funds = await AuctionContract.methods.getBidderFunds().call({from: bidder2});
      return funds;
    }
    const withdraw = async () => {
      let succeed = await AuctionContract.methods.withdrawOwner().send({from: owner});
      return succeed;
    }
    const ownerFunds = async () => {
      let funds = await AuctionContract.methods.getBidderFunds().call({from: owner});
      return funds;
    }

    // Modern dapp browsers...
    if (window.ethereum) {
      window.web3 = new Web3(ethereum);
      try {
        // Request account access if needed
        await ethereum.enable();
        // View account addresses to website
        var acc1 = document.getElementById("ownerAcc");
        acc1.innerHTML = owner;
        var acc2 = document.getElementById("bidder1Acc");
        acc2.innerHTML = bidder1;
        var acc3 = document.getElementById("bidder2Acc");
        acc3.innerHTML = bidder2;
        try{
          let funds1 = await bidder1Funds();
          var elm1 = document.getElementById("bidder1Funds");
          elm1.innerHTML = funds1;
        } catch(error){
            var elm1 = document.getElementById("bidder1Funds");
            elm1.innerHTML = 0;
        }
        try{
          let funds2 = await bidder2Funds();
          var elm2 = document.getElementById("bidder2Funds");
          elm2.innerHTML = funds2;
        } catch(error){
            var elm2 = document.getElementById("bidder2Funds");
            elm2.innerHTML = 0;
        }
        try{
          let funds = await ownerFunds();
          var elm = document.getElementById("ownerFunds");
          elm.innerHTML = funds;
        }catch(error){
          var elm = document.getElementById("ownerFunds");
          elm.innerHTML = 0;
        }

      } catch (error) {
        // User denied account access...
      }
      let rec = document.getElementById("ownerBtn");
      rec.addEventListener('click', async () => {
        try{
          let receive = await withdraw();
          window.location.reload();
          return false;
        }catch(e){
          console.log("Unable to withdraw");
        }
      });
    }
    // Non-dapp browsers...
    else {
      console.log('Non-Ethereum browser detected. You should consider trying MetaMask!');
    }
  });

</script>

</head>

<div class="menu">
  <nav>
    <div class="nav-wrapper">
      <a href="index.html" class="brand-logo right">Auction Dapp</a>
      <ul id="nav-mobile" class="left hide-on-med-and-down">
        <li><a href="bidder1.html">Bidder1</a></li>
        <li><a href="bidder2.html">Bidder2</a></li>
      </ul>
    </div>
  </nav>

<body>

<h4 class="center title">Bids & Addresses</h4>
      <table class="striped">
        <thead>
          <tr>
              <th>Name</th>
              <th>Address</th>
              <th>Bid</th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <td>owner</td>
            <td id="ownerAcc">""</td>
            <td id="ownerFunds"></td>
          </tr>
          <tr>
            <td>Bidder1</td>
            <td id="bidder1Acc">""</td>
            <td id="bidder1Funds"></td>
          </tr>
          <tr>
            <td>Bidder2</td>
            <td id="bidder2Acc">""</td>
            <td id="bidder2Funds"></td>
          </tr>
        </tbody>
      </table>
      <button id="ownerBtn" class="btn waves-effect waves-light right" type="submit" name="action">Withdraw bidding (owner)
        <i class="material-icons right">send</i>
      </button>
</div>
<style>
  .menu{
    width: 55%;
    position: relative;
    margin: auto;
  }
  .title{
    padding-top: 10px;
    padding-bottom: 20px;
  }
  #ownerBtn{
    padding-top: 2px;
  }
</style>
</body>
</html>
